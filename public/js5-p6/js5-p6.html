<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication</title>
    <link rel="stylesheet" type="text/css" href="../mvp.css">
    <style>
        section aside {
            width: 400px;
        }
        section pre {
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <main>
        <header>
            <h1>Authentication</h1>
            <p>This is an explanation about this demo. Remember, the JWT expiration is set.</p>
        </header>
        <section>
            <aside class="input-container">
            </aside>
            <aside class="response-container">
                <h1>Server response</h1>
            </aside>
        </section>
    </main>
</body>

<script>
    const setupLogin = () => {
        $inputContainer.innerHTML = `
            <h1>You must be logged in</h1>
            <p>No account? You can 
                <a href="#" class="instead">Sign up instead</a>
            </p>
            <label for="username">Username</label>
            <input class="username" name="username" type="text" size="35">
            <label for="password">Password</label>
            <input class="password" name="password" type="password" size="35">
            <button class="submit" type="button">Log In</button>
        `;
        const $instead = document.querySelector('.instead');
        const $username = document.querySelector('.username');
        const $password = document.querySelector('.password');
        const $submit = document.querySelector('.submit');
        const $alert = document.querySelector('.alert');

        $instead.addEventListener('click', setupSignup);
        $submit.addEventListener('click', () => {
            let status;
            fetch('/authentication/api/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: $username.value,
                    password: btoa($password.value)
                })
            })
                .then(res => {
                    status = res.status;
                    return res.json()
                })
                .then(data => {
                    $responseContainer.innerHTML = 
                    `<h1>Server responded ${status}</h1>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                });
        });

    };

    const setupSignup = () => {
        $inputContainer.innerHTML = `
            <h1>Create a new account</h1>
            <p>Already have one? You can 
                <a href="#" class="instead">Log in instead</a>
            </p>
            <label for="name">Full Name</label>
            <input class="name" name="name" type="text" size="35">
            <label for="email">Email</label>
            <input class="email" name="email" type="email" size="35">
            <label for="username">Username</label>
            <input class="username" name="username" type="text" size="35">
            <label for="password">Password</label>
            <input class="password" name="password" type="password" size="35">
            <button class="submit" type="button">Sign up</button>
        `;
        const $instead = document.querySelector(".instead");
        const $name = document.querySelector(".name");
        const $email = document.querySelector(".email");
        const $username = document.querySelector(".username");
        const $password = document.querySelector(".password");
        const $submit = document.querySelector(".submit");
        const $alert = document.querySelector('.alert');

        $instead.addEventListener('click', setupLogin);
        $submit.addEventListener('click', () => {
            let status;
            fetch('/authentication/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }, 
                body: JSON.stringify({
                    name: $name.value,
                    email: $email.value,
                    username: $username.value,
                    password: btoa($password.value)
                })
            })
                .then(res => {
                    status = res.status;
                    return res.json()
                })
                .then(data => {
                    $responseContainer.innerHTML = 
                    `<h1>Server responded ${status}</h1>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                })

        });
    };

    /* Get DOM elements */
    $inputContainer = document.querySelector('.input-container');
    $responseContainer = document.querySelector('.response-container')

    /* Start app */
    setupLogin();

</script>
</html>