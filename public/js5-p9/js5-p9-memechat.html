<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeChat</title>
    <link rel="stylesheet" type="text/css" href="/memechat/js5-p9-styles.css">
</head>

<body>
    <nav>
        <ul>
            <li><span class="logo">MEME CHAT</span></li>
            <li class="right"><span class="welcome"></span></li>
            <li><button class="logout">Logout</button></li>
        </ul>
    </nav>
    <div class="all-memes-container"></div>
    <div class="invisible-container" hidden></div>
    <div class="create-meme-container offscreen">
        <video class="video" width="640" height="480"></video> 
        <canvas class="canvas" width="640" height="480" hidden></canvas>
        <input class="caption-top caption" name="caption" type="text" placeholder="TOP TEXT"/>
        <input class="caption-bot caption" name="caption" type="text" placeholder="BOTTOM TEXT"/>
        <div class="message"></div>
        <button class="submit">Submit</button>
        <button class="cancel">Cancel</button>
    </div>
    <div>
        <button class="create-meme">Create a Meme</button>
    </div>
    <!--timeago.js fuzzy timestamps (https://timeago.org/)-->
    <script src="/memechat/timeago.js" type="text/javascript"></script> 
    <script>
        /* First thing, if user is not authenticated, redirect to login page */
        (async () => {
            console.log('app started');
            try {
                const response = await fetch('/memechat/api/session');
                const body = await response.json();
                if (body.username) {
                    globalUsername = body.username;
                    document.querySelector('.welcome').innerText = `Hey, ${globalUsername}!`;
                    return refreshMemes();
                }
                return window.location.replace(window.location.href + '/login');
            } catch (err) {
                console.error(err);
            }
        })();

        const refreshMemes = async (oldData) => {
            let data;
            try {
                const response = await fetch('/memechat/api/memes');
                const body = await response.json();
                if (body.error) return alert(body.error.message);

                /* Display most recent memes at top */
                data = Object.values(body);
                data.sort((a, b) => b.createdAt - a.createdAt);

                /* If there are more memes than last refresh, create more containers */
                const numMemes = document.querySelectorAll('.meme-container').length;
                const $memeContainers = addMemeContainers(data.length - numMemes);

                /* Update contents of meme container */
                $memeContainers.forEach((el, i) => {
                    el.querySelector('.meme-img').src = '/memechat/uploads/' + data[i].filename + '?' + Date.now();
                    el.querySelector('.meme-info-username').innerText = data[i].username;
                    el.querySelector('.timestamp').setAttribute('datetime', new Date(data[i].createdAt).toISOString());
                });

                timeago.render(document.querySelectorAll('.timestamp'));

            } catch (err) {
                console.error(err);
            }
            setTimeout(() => {refreshMemes(data)}, 2000);

        };

        const addMemeContainers = (n) => {
            $allMemesContainer.insertAdjacentHTML(
                'afterbegin',
                `<div class="meme-container">
                <a target="_blank"><img class="meme-img"></a>
                <div class="meme-info-container">
                <div class="meme-info-username">dummy text</div>
                <div class="timestamp" datetime=""></div>
                </div>
                </div>`.repeat(n)
            );
            return document.querySelectorAll('.meme-container');
        };

        /* Submit a meme */
        const submitMemeHandler = async () => {
            const captionTop = $captionTop.value.trim();
            const captionBot = $captionBot.value.trim();
            if (!captionTop && !captionBot) {
                return $message.innerText = 'Add a caption!';
            }
            $captionTop.value = '';
            $captionBot.value = '';
            $message.innerText ='';
            $createMemeContainer.classList.add('offscreen');

            const ctx = $canvas.getContext('2d');
            ctx.drawImage($video, 0, 0, 640, 480);
            const base64Data = $canvas
                .toDataURL()
                .replace(/^data:image\/png;base64,/, '');
            try {
                const response = await fetch('/memechat/api/memes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: globalUsername,
                        image: base64Data,
                        captionTop: captionTop.toUpperCase(), // real memes are all caps
                        captionBot: captionBot.toUpperCase()
                    })
                });
                const body = await response.json();
                if (body.err) alert(err);
            } catch (err) {
                console.error(err);
            }
        };

        const logoutHandler = async () => {
            try {
                await fetch('/memechat/api/logout');
                window.location.reload();
            } catch (err) {
                console.error(err);
            } 
        };

        const setupWebcam = async ($video) => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                });
                $video.srcObject = stream;
                $video.play();
            } catch (err) {
                console.error(err);
            }
        };

        /* DOM elements - */
        const $pageElements = document.querySelectorAll('.page');
        const $allMemesContainer = document.querySelector('.all-memes-container');
        const $invisibleContainer = document.querySelector('.invisible-container');
        const $video = document.querySelector('.video');
        const $canvas = document.querySelector('.canvas');
        const $logout = document.querySelector('.logout');
        const $captionTop = document.querySelector('.caption-top');
        const $captionBot = document.querySelector('.caption-bot');
        const $message = document.querySelector('.message');
        const $submit = document.querySelector('.submit');
        const $cancel = document.querySelector('.cancel');

        const $createMeme = document.querySelector('.create-meme');
        const $createMemeContainer = document.querySelector('.create-meme-container');

        /* Global variables */
        let globalUsername;


        setupWebcam($video);

        /* Event listeners */
        $logout.addEventListener('click', logoutHandler);
        $submit.addEventListener('click', () => {
            submitMemeHandler();
        });
        $captionTop.addEventListener('keydown', (e) => {
            if (e.key == 'Enter') return $captionBot.focus();
        });
        $captionBot.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            submitMemeHandler();
        });


        $createMeme.addEventListener('click', (e) => {
            $createMemeContainer.classList.remove('offscreen');
        });

        $cancel.addEventListener('click', (e) => {
            $createMemeContainer.classList.add('offscreen');
        })

    </script>
</body>
</html>