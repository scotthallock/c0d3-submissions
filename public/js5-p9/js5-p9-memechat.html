<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeChat</title>
    <link rel="stylesheet" type="text/css" href="/memechat/js5-p9-styles.css">
    <style>
        .all-memes {
            background-color: lavender;
        }
        .post-meme {
            background-color: floralwhite;
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li><h2>MEME CHAT</h2></li>
            <li><button>Create a Meme</button></li>
            <li class="right">Welcome, User</li>
            <li><button>About</button></li>
            <li><button class="logout">Logout</button></li>
        </ul>
    </nav>

    <div class="all-memes-container"></div>

    <button class="create-meme">Create a Meme</button>


    <div class="create-meme-container offscreen">
        <video class="video" width="640" height="480"></video> 
        <canvas class="canvas" width="640" height="480" hidden></canvas>
        <input class="caption-top" name="caption" type="text" placeholder="TOP TEXT"/>
        <input class="caption-bot" name="caption" type="text" placeholder="BOTTOM TEXT"/>
        <div class="message"></div>
        <button class="submit" hidden>Submit</button>
        <button class="cancel">Cancel</button>
    </div>


    <script>
        /* First thing, if user is not authenticated, redirect to login page */
        (async () => {
            console.log('app started');
            try {
                const response = await fetch('/memechat/api/session');
                const body = await response.json();
                if (body.username) {
                    globalUsername = body.username;
                    console.log(`user is authenticated! Welcome, ${globalUsername}` );
                    return renderAllMemes();
                }
                return window.location.replace(window.location.href + '/login');
            } catch (err) {
                console.error(err);
            }
        })();

        /* Render all the memes. Should be called every few seconds for live-updates */
        const renderAllMemes = async () => {
            try {
                const response = await fetch('/memechat/api/memes');
                const body = await response.json();
                if (body.error) {
                    return alert(body.error.message);
                }
                const data = Object.values(body);

                $allMemesContainer.innerHTML = data.reduce((acc, e) => {
                    return `
                        <div class="meme-container">
                        <div>${e.username}</div>
                        <a target="_blank" href="/memechat/uploads/${e.filename}">
                        <img class="meme-img" src="/memechat/uploads/${e.filename}">
                        </a>
                        <div>${e.createdAt}</div>
                        </div>
                        ` + acc;
                }, '');
            } catch (err) {
                console.error(err);
            }
            setTimeout(renderAllMemes, 1000);
        };
        renderAllMemes();

        /* Submit a meme */
        const submitMemeHandler = async () => {
            const captionTop = $captionTop.value.trim();
            const captionBot = $captionBot.value.trim();
            if (!captionTop && !captionBot) {
                return $message.innerText = 'Add a caption!';
            }
            const context = $canvas.getContext('2d');
            context.drawImage($video, 0, 0, 640, 480);
            const base64Data = $canvas
                .toDataURL()
                .replace(/^data:image\/png;base64,/, '');
            try {
                const response = await fetch('/memechat/api/memes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: globalUsername,
                        image: base64Data,
                        captionTop,
                        captionBot
                    })
                });
                const body = await response.json();
                if (body.err) {
                    $message.innerText = body.err.message;
                    return;
                }
                console.log('meme creation success');
                // call render memes here?

            } catch (err) {
                console.error(err);
            }
        };

        const logoutHandler = async () => {
            try {
                await fetch('/memechat/api/logout');
                window.location.reload();
            } catch (err) {
                console.error(err);
            } 
        };

        const setupWebcam = async ($video) => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                });
                $video.srcObject = stream;
                $video.play();
            } catch (err) {
                console.error(err);
            }
        };

        /* DOM elements - */
        const $pageElements = document.querySelectorAll('.page');
        const $allMemesContainer = document.querySelector('.all-memes-container');
        const $video = document.querySelector('.video');
        const $canvas = document.querySelector('.canvas');
        const $logout = document.querySelector('.logout');
        const $captionTop = document.querySelector('.caption-top');
        const $captionBot = document.querySelector('.caption-bot');
        const $message = document.querySelector('.message');
        const $submit = document.querySelector('.submit');
        const $cancel = document.querySelector('.cancel');

        const $createMeme = document.querySelector('.create-meme');
        const $createMemeContainer = document.querySelector('.create-meme-container');

        /* Global variables */
        let globalUsername;


        setupWebcam($video);
        $submit.hidden = false;
        // $captionTop.focus();

        /* Event listeners */
        $logout.addEventListener('click', logoutHandler);
        $submit.addEventListener('click', () => {
            submitMemeHandler();
        });
        $captionTop.addEventListener('keydown', (e) => {
            if (e.key == 'Enter') return $captionBot.focus();
        });
        $captionBot.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            submitMemeHandler();
        });


        $createMeme.addEventListener('click', (e) => {
            $createMemeContainer.classList.remove('offscreen');
        });

        $cancel.addEventListener('click', (e) => {
            $createMemeContainer.classList.add('offscreen');
        })

    </script>
</body>
</html>